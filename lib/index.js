"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var ora=require("ora"),chalk=require("chalk"),fs=require("fs"),path=require("path"),open=require("open"),crossSpawn=require("cross-spawn"),inquirer=require("inquirer"),os=require("os"),child_process=require("child_process"),commander=require("commander");function _interopDefaultLegacy(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function _interopNamespace(r){if(r&&r.__esModule)return r;var n=Object.create(null);return r&&Object.keys(r).forEach(function(e){var t;"default"!==e&&(t=Object.getOwnPropertyDescriptor(r,e),Object.defineProperty(n,e,t.get?t:{enumerable:!0,get:function(){return r[e]}}))}),n.default=r,Object.freeze(n)}var ora__default=_interopDefaultLegacy(ora),chalk__default=_interopDefaultLegacy(chalk),fs__default=_interopDefaultLegacy(fs),path__default=_interopDefaultLegacy(path),open__default=_interopDefaultLegacy(open),inquirer__default=_interopDefaultLegacy(inquirer),__assign=function(){return(__assign=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var a in t=arguments[r])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e}).apply(this,arguments)};function __decorate(e,t,r,n){var a,i=arguments.length,o=i<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;0<=s;s--)(a=e[s])&&(o=(i<3?a(o):3<i?a(t,r,o):a(t,r))||o);return 3<i&&o&&Object.defineProperty(t,r,o),o}function __awaiter(e,o,s,u){return new(s=s||Promise)(function(r,t){function n(e){try{i(u.next(e))}catch(e){t(e)}}function a(e){try{i(u.throw(e))}catch(e){t(e)}}function i(e){var t;e.done?r(e.value):((t=e.value)instanceof s?t:new s(function(e){e(t)})).then(n,a)}i((u=u.apply(e,o||[])).next())})}function __generator(r,n){var a,i,o,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(a)throw new TypeError("Generator is already executing.");for(;s;)try{if(a=1,i&&(o=2&t[0]?i.return:t[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,t[1])).done)return o;switch(i=0,o&&(t=[2&t[0],o.value]),t[0]){case 0:case 1:o=t;break;case 4:return s.label++,{value:t[1],done:!1};case 5:s.label++,i=t[1],t=[0];continue;case 7:t=s.ops.pop(),s.trys.pop();continue;default:if(!(o=0<(o=s.trys).length&&o[o.length-1])&&(6===t[0]||2===t[0])){s=0;continue}if(3===t[0]&&(!o||t[1]>o[0]&&t[1]<o[3])){s.label=t[1];break}if(6===t[0]&&s.label<o[1]){s.label=o[1],o=t;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(t);break}o[2]&&s.ops.pop(),s.trys.pop();continue}t=n.call(r,s)}catch(e){t=[6,e],i=0}finally{a=o=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}}function __spreadArrays(){for(var e=0,t=0,r=arguments.length;t<r;t++)e+=arguments[t].length;for(var n=Array(e),a=0,t=0;t<r;t++)for(var i=arguments[t],o=0,s=i.length;o<s;o++,a++)n[a]=i[o];return n}var Commit,Environment,TaskSymbol,compose=function(t){return function(e){return t.reduce(function(r,n){return function(e,t){return r(e,function(e){return n(e,t)})}})(e,function(e){return Promise.resolve(e)})}},timer=function(){var t={};return{start:function(e){t[e]={time:Date.now(),started:!0}},end:function(e){e=t[e];return e&&e.started?(e.started=!1,Date.now()-e.time):0}}}(),padZero=function(e,t){return(""+new Array(t).fill("0").join("")+String(e)).substr(-t)},dateFormater=function(e,r){var e=new Date(e),n={"M+":e.getMonth()+1,"d+":e.getDate(),"h+":e.getHours()%12==0?12:e.getHours()%12,"H+":e.getHours(),"m+":e.getMinutes(),"s+":e.getSeconds(),"q+":Math.floor((e.getMonth()+3)/3),S:e.getMilliseconds()};return/(y+)/.test(r)&&(r=r.replace(RegExp.$1,String(e.getFullYear()).substr(4-RegExp.$1.length))),Object.keys(n).filter(function(e){return new RegExp("("+e+")").test(r)}).forEach(function(e){var t=n[e];r=r.replace(new RegExp("("+e+")"),padZero(t,2))}),r},formatToDateTime=function(e){return dateFormater(e,"yyyy-MM-dd HH-mm-ss-S")};!function(){var e;(Commit||(Commit={})).typesMap=((e={}).feat={name:"新功能",value:"feat"},e.fix={name:"修复",value:"fix"},e.build={name:"构建打包",value:"build"},e.style={name:"代码样式",value:"style"},e.refactor={name:"重构（不新增功能也不是修改bug）",value:"refactor"},e.test={name:"添加测试",value:"test"},e.chore={name:"流程或工具更改",value:"chore"},e.conflict={name:"冲突解决",value:"conflict"},e.merge={name:"代码合并",value:"merge"},e)}(),function(e){e.DEBUG_MODE=!1,e.DIR_HOME=process.env.HOME,e.DIR_STORAGE=path__default.default.resolve(e.DIR_HOME,".ik-gz"),e.FILE_USER_ACCOUNT=path__default.default.resolve(e.DIR_STORAGE,"user_account"),e.ERROR_CODE=10}(Environment=Environment||{}),function(e){e.FunctionalTask=Symbol("functional_task"),e.ClassTask=Symbol("class_task")}(TaskSymbol=TaskSymbol||{});var EnumExecuteLevel,LOG_DIR=Environment.DIR_STORAGE,ERROR_CODE=Environment.ERROR_CODE,FatalReport=function(e,t,r){var n=r.value;r.value=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];try{writeDownErrorLog(e.join(" ")),n.apply(this,e)}catch(e){tips.warn(e)}}},ExitProcess=function(e,t,r){var n=r.value;r.value=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];try{n.apply(this,e)}finally{process.exit(ERROR_CODE)}}},writeDownErrorLog=function(e){if(Environment.DEBUG_MODE){var t=LOG_DIR+"/"+formatToDateTime(Date.now())+".log";try{fs__default.default.existsSync(LOG_DIR)||fs__default.default.mkdirSync(LOG_DIR,{recursive:!0}),fs__default.default.appendFileSync(t,e)}catch(e){tips.warn(e)}}},Tips=function(){function e(){this.loading=ora__default.default({spinner:{interval:80,frames:["-","\\","|","/"]}})}return e.prototype.showLoading=function(e){return this.loading.start(chalk__default.default.cyan(e))},e.prototype.hideLoading=function(){return this.loading.stop()},e.prototype.succeed=function(e){return this.loading.succeed(chalk__default.default.green(e))},e.prototype.log=function(e){return console.log(chalk__default.default.blue(e))},e.prototype.info=function(e){return this.loading.info(chalk__default.default.blue(e))},e.prototype.warn=function(e){return this.loading.warn(chalk__default.default.yellow(e))},e.prototype.error=function(e){return this.loading.fail(chalk__default.default.red(e))},__decorate([ExitProcess,FatalReport],e.prototype,"error",null),e}(),tips=new Tips,DEFAULT_CONFIG={description:"未命名流程",validate:function(){return!0},steps:[]},Workflow=function(){function e(e,t){this.name=e,this.config=__assign(__assign({},DEFAULT_CONFIG),t),this.description=this.config.description,this.register()}return e.prototype.register=function(){e.maps.has(this.name)&&tips.warn("已存在【"+this.name+"】流程"),e.maps.set(this.name,this)},e.prototype.validateStep=function(e){var t,r="未命名任务",n=function(){},a=function(){return!1};return"function"!=typeof e?(r=e.name,a=null!==(t=e.skip)&&void 0!==t?t:a,"function"!=typeof(n=e.use)&&tips.error("【"+r+"】中找不到'use'")):n=e,{name:r,task:n,skip:a}},e.prototype.createTaskQueue=function(){var e=this;return this.config.steps.filter(Boolean).map(function(s,u){return function(i,o){return __awaiter(e,void 0,void 0,function(){var t,r,n,a;return __generator(this,function(e){switch(e.label){case 0:return r=this.validateStep(s),t=r.name,a=r.task,n=r.skip,r=u+1,tips.log(""),[4,n(i)];case 1:return e.sent()?(tips.log("=="+r+"、【"+t+"】被跳过=="),[4,o(i)]):[3,3];case 2:return[2,e.sent()];case 3:return tips.log("=="+r+"、开始【"+t+"】=="),timer.start(t),[4,a(i)];case 4:return n=e.sent(),a=timer.end(t),tips.log("=="+r+"、【"+t+"】完成，耗时"+a+"ms=="),[4,o(n)];case 5:return[2,e.sent()]}})})}})},e.prototype.start=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,this.config.validate()];case 1:return e.sent()?(tips.succeed("开始【"+this.description+"】"),[2,compose(this.createTaskQueue())()]):(tips.warn("【"+this.description+"】验证失败，已终止"),[2])}})})},e.maps=new Map,e}(),CODE_SUCCESS=0,CODE_ERROR=10086,promisifySpawn=function(t,i,o){return void 0===o&&(o={}),new Promise(function(r,n){var e=crossSpawn.spawn(t,i,__assign(__assign({},o),{stdio:"pipe"})),a=[];e.stdout.on("data",function(e){a.push(Buffer.isBuffer(e)?e:Buffer.from(e))}),e.stderr.on("data",function(e){a.push(Buffer.isBuffer(e)?e:Buffer.from(e))}),e.on("close",function(e){var t=Buffer.concat(a).toString();null==e||e===CODE_SUCCESS?r({code:CODE_SUCCESS,message:t}):n({code:e,message:t})}),e.on("error",function(e){n({code:CODE_ERROR,message:e.message+" \n"+e.stack})})})};!function(e){e[e.None=0]="None",e[e.Warn=1]="Warn",e[e.Fatal=2]="Fatal"}(EnumExecuteLevel=EnumExecuteLevel||{});var AskFor,getWarnMessageInExecute=function(e){return e instanceof Error?(e.stack?"STACK:"+e.stack+" ":"")+"\n"+e.message:"CODE:"+e.code+" \n"+e.message},getErrorMessageInExecute=function(e,t){return e instanceof Error?"ERROR IN【"+t+"】"+(e.stack?"\nSTACK:"+e.stack+" ":"")+"\n"+e.message:"ERROR IN【"+t+"】\nCODE:"+e.code+" \n"+e.message},execute=function(n,a,i){return void 0===i&&(i={}),__awaiter(void 0,void 0,void 0,function(){var t,r;return __generator(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,promisifySpawn(n,a,i)];case 1:return[2,e.sent()];case 2:return t=e.sent(),r=n+" "+a.join(" "),i.level===EnumExecuteLevel.Fatal?tips.error(getErrorMessageInExecute(t,r)):i.level===EnumExecuteLevel.Warn&&tips.warn(getWarnMessageInExecute(t)),[2,t];case 3:return[2]}})})},cmdGit="git",NoNewLine=function(a){return function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];return __awaiter(void 0,void 0,void 0,function(){var t,r;return __generator(this,function(e){switch(e.label){case 0:return[4,a.apply(void 0,n)];case 1:return r=e.sent(),t=r.message,r=r.code,[2,{message:t.trim(),code:r}]}})})}},git=NoNewLine(function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return execute(cmdGit,e,{level:EnumExecuteLevel.Fatal})}),gitWithoutBreak=NoNewLine(function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return execute(cmdGit,e,{level:EnumExecuteLevel.Warn})}),gitInSilent=NoNewLine(function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return execute(cmdGit,e,{level:EnumExecuteLevel.None})}),getLineCount=function(e){return(e.match(/\r\n|\r|\n/g)||[]).length};!function(e){var r=this;e.commitMessage=function(){return __awaiter(r,void 0,void 0,function(){var t,r;return __generator(this,function(e){switch(e.label){case 0:return t=Object.values(Commit.typesMap),[4,inquirer__default.default.prompt([{type:"list",name:"type",message:"选择提交类型",choices:t,pageSize:t.length},{type:"input",name:"message",message:"填写提交内容",filter:function(e){return e.trim()},validate:function(e){e=String(e).trim();return 0===e.length?"请输入本次提交内容":!(70<e.length)||"提交内容不能超过70个字"}}])];case 1:return r=e.sent(),t=r.type,r=r.message,[2,t+": "+r]}})})},e.shouldContinue=function(e){var t=e.message;return __awaiter(r,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,inquirer__default.default.prompt([{type:"confirm",name:"confirm",message:t||"是否继续？",default:!0}])];case 1:return[2,e.sent().confirm]}})})}}(AskFor=AskFor||{});var Git,MergeRequest,File,RegConflictMessage=/CONFLICT/i,checkConflict=function(e){return RegConflictMessage.test(e)};!function(o){var s=this;o.init=function(){return git("init")},o.config=function(e){var e=void 0===e?{}:e,t=e.name,r=e.email;return __awaiter(s,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return t?[4,git("config","user.name",'"'+t+'"')]:[3,2];case 1:e.sent(),e.label=2;case 2:return r?[4,git("config","user.email",'"'+r+'"')]:[3,4];case 3:e.sent(),e.label=4;case 4:return[2]}})})},o.commit=function(e){var t=e.message;return __awaiter(s,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return tips.showLoading("检查工作区"),[4,git("status","-z","-u")];case 1:return e.sent().message?(tips.showLoading("添加文件"),[4,git("add","-A")]):(tips.error("无需要提交的文件"),[2]);case 2:return e.sent(),tips.showLoading("提交"),[4,git("commit","-m",t)];case 3:return e.sent(),tips.hideLoading(),[2]}})})},o.pull=function(){return __awaiter(s,void 0,void 0,function(){var t,r;return __generator(this,function(e){switch(e.label){case 0:return[4,o.getCurrentBranchName()];case 1:return t=e.sent(),tips.showLoading("拉取远程【"+t+"】"),[4,gitInSilent("pull")];case 2:return r=e.sent(),t=r.code,r=r.message,tips.hideLoading(),t!==CODE_SUCCESS&&checkConflict(r)?[4,o.waitForDealWithConflict()]:[3,6];case 3:return e.sent()?[4,o.commit({message:"conflict: 合并冲突"})]:[3,5];case 4:return e.sent(),[3,6];case 5:return tips.error("发现冲突，请解决后再提交"),[2];case 6:return[2]}})})},o.push=function(){return __awaiter(s,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,o.pull()];case 1:return e.sent(),[4,o.getCurrentBranchName()];case 2:return t=e.sent(),tips.showLoading("推送至远程【"+t+"】"),[4,gitInSilent("push","origin",t)];case 3:return e.sent(),tips.hideLoading(),[2]}})})},o.pushForceDangerously=function(e){var t=e.url,r=e.branch;return __awaiter(s,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,AskFor.shouldContinue({message:"危险！将要强推至【"+t+"】：分支【"+r+"】，请确认"})];case 1:return e.sent()?(tips.showLoading("推送至远程【"+t+"】：分支【"+r+"】"),[4,git("push","-u",t,"HEAD:"+r,"--force")]):[3,3];case 2:return e.sent(),tips.hideLoading(),[3,4];case 3:return tips.error("已取消"),[2,Promise.reject("已取消")];case 4:return[2]}})})},o.checkout=function(e){var a=e.branch;return __awaiter(s,void 0,void 0,function(){var t,r,n;return __generator(this,function(e){switch(e.label){case 0:return tips.showLoading("检查工作区"),[4,git("status","-z","-u")];case 1:return t=e.sent().message,tips.hideLoading(),(t=t)?[4,AskFor.shouldContinue({message:"工作区尚有未提交更改，是否切换分支？"})]:[3,3];case 2:t=!e.sent(),e.label=3;case 3:return t?(tips.error("已取消"),[2,Promise.reject("已取消")]):(tips.showLoading("切换至【"+a+"】"),[4,o.getIsExistLocalBranch({branch:a})]);case 4:return e.sent()?[4,git("checkout",a)]:[3,6];case 5:return e.sent(),[3,9];case 6:return r=git,n=["checkout","-b",a],[4,o.getUpstreamBranchName({branch:a})];case 7:return[4,r.apply(void 0,n.concat([e.sent()]))];case 8:e.sent(),e.label=9;case 9:return[4,o.pull()];case 10:return e.sent(),tips.hideLoading(),[2]}})})},o.merge=function(e){var a=e.branch,i=e.message;return __awaiter(s,void 0,void 0,function(){var t,r,n;return __generator(this,function(e){switch(e.label){case 0:return tips.showLoading("正在合并【"+a+"】"),[4,o.getCurrentBranchName()];case 1:return r=e.sent(),[4,o.getUpstreamBranchName({branch:a})];case 2:return n=e.sent(),[4,gitInSilent("merge",n,"--no-ff","-m",t="merge: Merge branch '"+a+"' into '"+r+"'"+(i?" -> "+i:""))];case 3:return n=e.sent(),r=n.code,n=n.message,tips.hideLoading(),r!==CODE_SUCCESS&&checkConflict(n)?[4,o.waitForDealWithConflict()]:[3,7];case 4:return e.sent()?[4,o.commit({message:t})]:[3,6];case 5:return e.sent(),[3,7];case 6:tips.error("发现冲突，请解决后再提交"),e.label=7;case 7:return[2]}})})},o.clone=function(e){var r=e.url,t=e.branch,n=void 0===t?"master":t,e=e.path,a=void 0===e?"":e;return __awaiter(s,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return t="克隆【"+r+"】，分支【"+n+"】",tips.showLoading(t),[4,git("clone",r,"-b",n,a)];case 1:return e.sent(),tips.succeed(t),[2]}})})},o.getCurrentBranchName=function(){return __awaiter(s,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,git("rev-parse","--abbrev-ref","HEAD")];case 1:return[2,e.sent().message]}})})},o.getIsExistLocalBranch=function(e){var t=e.branch;return __awaiter(s,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,git("branch","--list",""+t)];case 1:return[2,""!==e.sent().message.trim()]}})})},o.getUpstreamBranchName=function(e){var n=e.branch;return __awaiter(s,void 0,void 0,function(){var t,r;return __generator(this,function(e){switch(e.label){case 0:return[4,o.getIsExistLocalBranch({branch:n})];case 1:return e.sent()?[4,gitWithoutBreak("rev-parse","--abbrev-ref",n+"@{u}")]:[3,6];case 2:return(r=e.sent(),t=r.code,r=r.message,t)?(tips.showLoading("上游分支不存在，开始创建上游分支"),[4,git("push","-u","origin",n)]):[3,4];case 3:return e.sent(),tips.hideLoading(),[2,o.getUpstreamBranchName({branch:n})];case 4:return r.replace("origin/","")!==n&&tips.warn("本地分支：【"+n+"】和上游分支：【"+r+"】似乎不一致"),[2,r];case 5:return[3,7];case 6:return[2,"origin/"+n];case 7:return[2]}})})},o.getTobeCommit=function(){return __awaiter(s,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,git("status","-s")];case 1:return[2,e.sent().message]}})})},o.getToBePushed=function(){return __awaiter(s,void 0,void 0,function(){var t,r;return __generator(this,function(e){switch(e.label){case 0:return[4,o.getCurrentBranchName()];case 1:return t=e.sent(),[4,o.getUpstreamBranchName({branch:t})];case 2:return r=e.sent(),[4,git("log",t,"^"+r,"--oneline")];case 3:return[2,e.sent().message]}})})},o.waitForDealWithConflict=function(){return __awaiter(s,void 0,void 0,function(){var t,r,n;return __generator(this,function(e){switch(e.label){case 0:return[4,gitWithoutBreak("--no-pager","diff","--check")];case 1:return t=e.sent(),r=t.message,t.code===CODE_SUCCESS?[3,6]:[4,AskFor.shouldContinue({message:"还有"+getLineCount(r)+"处冲突未解决，请先解决，是否继续？"})];case 2:return e.sent()?[4,o.waitForDealWithConflict()]:[3,4];case 3:return n=e.sent(),[3,5];case 4:n=!1,e.label=5;case 5:return[2,n];case 6:return[2,!0]}})})},o.getRemoteUrl=function(){return __awaiter(s,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,git("remote","get-url","--push","origin")];case 1:return[2,e.sent().message]}})})},o.getLastCommitMessage=function(e){var r=e.branch;return __awaiter(s,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,o.getUpstreamBranchName({branch:r})];case 1:return t=e.sent(),[4,git("log",t,"-1","--format=%s")];case 2:return[2,e.sent().message]}})})},o.getLastCommitBody=function(e){var r=e.branch;return __awaiter(s,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,o.getUpstreamBranchName({branch:r})];case 1:return t=e.sent(),[4,git("log",t,"-1","--format=%b")];case 2:return[2,e.sent().message]}})})},o.getLastCommitHash=function(e){var r=e.branch;return __awaiter(s,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,o.getUpstreamBranchName({branch:r})];case 1:return t=e.sent(),[4,git("log",t,"-1","--format=%H")];case 2:return[2,e.sent().message]}})})}}(Git=Git||{}),function(e){function c(e){var t=e.projectUrl,r=e.sourceBranch,n=e.targetBranch,e=e.title;return"https://"+t+"/merge_requests/new?"+new URLSearchParams({"merge_request[title]":e,"merge_request[source_branch]":r,"merge_request[target_branch]":n}).toString()}function l(e){return(e.match(r)||[""])[0].replace(/\:/,"/")}var t=this,r=/(?<=(git@|https:\/\/)).*(?=\.git)/;e.create=function(e){var i=e.projectUrl,o=e.sourceBranch,s=e.targetBranch,u=e.title;return __awaiter(t,void 0,void 0,function(){var t,r,n,a;return __generator(this,function(e){switch(e.label){case 0:return t=c,a={},r=l,(n=i)?[3,2]:[4,Git.getRemoteUrl()];case 1:n=e.sent(),e.label=2;case 2:return a=t.apply(void 0,[(a.projectUrl=r.apply(void 0,[n]),a.sourceBranch=o,a.targetBranch=s,a.title=u,a)]),tips.info("即将打开："+a),[2,open__default.default(a)]}})})}}(MergeRequest=MergeRequest||{}),function(e){var r=this;e.copyTo=function(e){var t=e.from,e=e.to;return execute("cp",__spreadArrays(["-R"],Array.isArray(t)?t:[t],[e]))},e.entryDirectory=function(e){var t=e.dir;return __awaiter(r,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return t=t||os.homedir(),[4,execute("cd",[t])];case 1:return e.sent(),process.chdir(t),[2]}})})},e.generateDir=function(e){e=e.dir;return execute("mkdir",["-p",e])},e.getList=function(e){var e=(void 0===e?{}:e).dir,t=void 0===e?".":e;return __awaiter(r,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,execute("ls",["-A",t])];case 1:return[2,e.sent().message.split("\n").filter(Boolean)]}})})}}(File=File||{});var Shell,TEN_MBYTE=10485760,CODE_SUCCESS$1=0;(Shell||(Shell={})).run=function(e){var t=e.cmd;return new Promise(function(n,a){var e=child_process.exec(t,{maxBuffer:TEN_MBYTE,env:process.env,encoding:"utf8"},function(e,t,r){!e||void 0===e.code||null===e.code||e.code===CODE_SUCCESS$1?n({stdout:t,stderr:r}):(tips.error(String(e)),a({stdout:t,stderr:r}))});e.stdout&&e.stdout.pipe(process.stdout)})};var ActionsModules=Object.freeze({__proto__:null,get MergeRequest(){return MergeRequest},get File(){return File},get Git(){return Git},get AskFor(){return AskFor},get Shell(){return Shell}}),createTaskFactory=function(s){return function(){for(var o=[],e=0;e<arguments.length;e++)o[e]=arguments[e];return function(i){return __awaiter(void 0,void 0,void 0,function(){var t,r,n,a;return __generator(this,function(e){switch(e.label){case 0:return r=(t=s).apply,n=[void 0],"function"!=typeof o[0]?[3,2]:[4,o[0](i)];case 1:return a=e.sent(),[3,3];case 2:a=o,e.label=3;case 3:return[2,r.apply(t,n.concat([a]))]}})})}}},Tasks=Object.keys(ActionsModules).reduce(function(e,t){var r=ActionsModules[t];return __assign(__assign({},e),((e={})[t]=Object.keys(r).reduce(function(e,t){return __assign(__assign({},e),((e={})[t]=createTaskFactory(r[t]),e))},{}),e))},{}),workStart=function(e){var e=void 0===e?{}:e,r=e.from,n=e.workflowId;return __awaiter(void 0,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return commander.program.option("-f, --from <path>","初始化文件路径").parse(process.argv),(r=r||commander.program.from)?[4,Promise.resolve().then(function(){return _interopNamespace(require(path__default.default.join(process.cwd(),r)))})]:[3,2];case 1:e.sent(),e.label=2;case 2:return Workflow.maps.forEach(function(e,t){commander.program.command(t).description(e.description).action(function(){e.start()})}),n&&Workflow.maps.has(n)?null!==(t=Workflow.maps.get(n))&&void 0!==t&&t.start():commander.program.parse(process.argv),[2]}})})};exports.Tasks=Tasks,exports.Workflow=Workflow,exports.workStart=workStart;
